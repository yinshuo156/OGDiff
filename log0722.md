# 特征空间扩散（Feature Diffusion）改造说明

## 1. 改造目标

将原有基于参数空间（如原型/权重）扩散的结构，升级为**特征空间扩散**：即对backbone输出的特征向量进行加噪、去噪，再送入分类器进行训练和推理。

---

## 2. 主要修改点

### 2.1 model_diff.py
- 新增 `FeatureDiffusion` 类，实现特征向量的加噪与去噪（MLP结构）。
- 新增 `FeatureDiffusionNet` 类，集成 backbone、feature_diffusion、分类器，forward流程为：图片→特征→加噪→去噪→分类。

### 2.2 main_diff_eval.py
- 新增 `FeatureDiffusionNet` 初始化，支持resnet18/resnet50/convnet等backbone。
- 分类器可选用线性层或原型分类器（默认线性层）。
- 训练循环修改为：
  - backbone 得到特征
  - 特征加噪声
  - 扩散模型去噪
  - 分类器输出
  - 损失 = 分类损失 + 去噪重建损失
- 新增 `train_loader`，用标准dataloader加载训练集。

---

## 3. 关键代码结构

### 3.1 FeatureDiffusion
```python
class FeatureDiffusion(nn.Module):
    def __init__(self, feature_dim, num_timesteps=100, hidden_dim=512): ...
    def forward(self, noisy_feature, t): ...
    def q_sample(self, x_start, t, noise=None): ...
```

### 3.2 FeatureDiffusionNet
```python
class FeatureDiffusionNet(nn.Module):
    def __init__(self, backbone, classifier, feature_dim, diffusion_steps=100, hidden_dim=512): ...
    def forward(self, x, t=None, noise=None, return_feature=False): ...
```

### 3.3 训练主循环
```python
for epoch in range(num_epoch):
    net.train()
    for batch in train_loader:
        x, y = batch[0].to(device), batch[1].to(device)
        logits, feat, noisy_feat, denoised_feat, t, noise = net(x, return_feature=True)
        loss_cls = criterion_cls(logits, y)
        loss_rec = criterion_rec(denoised_feat, feat)
        loss = loss_cls + loss_rec
        optimizer.zero_grad()
        loss.backward()
        optimizer.step()
```

---

## 4. 使用与注意事项

- 需保证 `train_loader` 输出 (x, y)，x为图片，y为标签。
- 数据集路径需真实存在，否则会报错。
- 可根据需要将分类器替换为原型分类器（ProtoClassifier）。
- 损失函数可根据实验需求调整权重。
- 其它评估/保存/多domain等逻辑可在此基础上扩展。 



现在模型可以接入多尺度/多层特征扩散吗？尝试在diffusion下合适位置进行实现并保证正常运行